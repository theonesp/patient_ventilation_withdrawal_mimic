### Infusion Drugs

#### propofol

##### Data extraction

```{r eval=FALSE, include=FALSE}
query<-"
SELECT
  inputevents_mv.subject_id,
  inputevents_mv.hadm_id,
  inputevents_mv.icustay_id,
  inputevents_mv.itemid,
  COALESCE(inputevents_mv.storetime,inputevents_mv.starttime) AS charttime_drugs_infusion,
  inputevents_mv.rate,
  inputevents_mv.rateuom,
  inputevents_mv.ordercategorydescription
From
  `physionet-data.mimiciii_clinical.inputevents_mv` inputevents_mv
    
WHERE
  inputevents_mv.itemid IN (222168)
  AND ordercategorydescription = 'Continuous Med'
"

propofol_infusion_cohort_24<-query_exec(query, project = project_HST,use_legacy_sql = F,max_pages = Inf)

propofol_infusion_cohort_24$itemid[propofol_infusion_cohort_24$itemid==222168]<-'propofol'
#Valium (Diazepam)
#We tried valium and it didn't increase the number of patients, still 84 after ext
```

##### Units equivalence

propofol = 1 milligram of lorazepam (ativan)(ref) IV is equivalent to 2 mg midazolam IV. 
1 mg of midazolam = 0.5 mg of Ativan

!! TODO: Change units equivalence


```{r}
#nested if else function
!! TODO: Change units equivalence
i <- function(if_stat, then) {
  if_stat <- lazyeval::expr_text(if_stat)
  then    <- lazyeval::expr_text(then)
  sprintf("ifelse(%s, %s, ", if_stat, then)
}

e <- function(else_ret) {
  else_ret <- lazyeval::expr_text(else_ret)
  else_ret
}

ie <- function(...) {
  args <- list(...)
  
  for (i in 1:(length(args) - 1) ) {
    if (substr(args[[i]], 1, 6) != "ifelse") {
      stop("All but the last argument, need to be i functions.", call. = FALSE)
    }
  }
  if (substr(args[[length(args)]], 1, 6) == "ifelse"){
    stop("Last argument needs to be an e function.", call. = FALSE)
  }
  args$final <- paste(rep(')', length(args) - 1), collapse = '')
  eval_string <- do.call('paste', args)
  eval(parse(text = eval_string))
}



propofol_infusion_cohort_24['opioid_rate']<-NA
propofol_infusion_cohort_24$opioid_rate <- 
  ie(
    #1 mg of midazolam = 0.5 mg of Ativan
    i(propofol_infusion_cohort_24$itemid=='Midazolam',round(propofol_infusion_cohort_24$rate*0.5,2)),
    e(round(propofol_infusion_cohort_24$rate,2))
  )
```


##### Epochs Creation (max rate mg/h)

```{r eval=FALSE, include=FALSE}
propofol_infusion_from_patients_tofilter<-inner_join(cmo_and_extubation_and_death_24[,c('subject_id','icustay_id','charttime.extubation','deathtime')], propofol_infusion_cohort_24)

# we noticed some timezones adrugs_infusion alteterd, so we drugs_infusionset them
propofol_infusion_from_patients_tofilter$charttime_drugs_infusion<-as.character(propofol_infusion_from_patients_tofilter$charttime_drugs_infusion)
propofol_infusion_from_patients_tofilter$charttime.extubation<-as.character(propofol_infusion_from_patients_tofilter$charttime.extubation)
propofol_infusion_from_patients_tofilter$deathtime<-as.character(propofol_infusion_from_patients_tofilter$deathtime)


propofol_infusion_from_patients_tofilter$charttime_drugs_infusion<-as.POSIXct(propofol_infusion_from_patients_tofilter$charttime_drugs_infusion, format='%Y-%m-%d %H:%M:%S', tz="GMT")
propofol_infusion_from_patients_tofilter$charttime.extubation<-as.POSIXct(propofol_infusion_from_patients_tofilter$charttime.extubation, format='%Y-%m-%d %H:%M:%S', tz="GMT")
propofol_infusion_from_patients_tofilter$deathtime<-as.POSIXct(propofol_infusion_from_patients_tofilter$deathtime, format='%Y-%m-%d %H:%M:%S', tz="GMT")

propofol_infusion_from_patients_tofilter['time_from_ext_to_propofol_infusion_min']<-difftime(propofol_infusion_from_patients_tofilter$charttime_drugs_infusion,propofol_infusion_from_patients_tofilter$charttime.extubation,units = 'mins')


#Drug Push is Bolus, so I filtered them out
propofol_infusion_after_ext<-propofol_infusion_from_patients_tofilter %>%
  filter( 
    time_from_ext_to_propofol_infusion_min >=0 
  )

# propofol =  1 milligram of morphine IV (225154) is equivalent to .01 mg Fentanyl IV (221744).

n_distinct(propofol_infusion_after_ext$subject_id) #84 patients 1/7/18

library(dplyr)
## if(any(gdrugs_infusionpl("package:plyr", search()))) detach("package:plyr") else message("plyr not loaded")
cohort_with_propofol_infusion_epoch<-propofol_infusion_after_ext %>%
  mutate(
    propofol_infusion_epoch_01=if_else(time_from_ext_to_propofol_infusion_min>=0 & time_from_ext_to_propofol_infusion_min<=60,opioid_rate,NULL)
    ,propofol_infusion_epoch_02=if_else(time_from_ext_to_propofol_infusion_min>60 & time_from_ext_to_propofol_infusion_min<=120,opioid_rate,NULL)
    ,propofol_infusion_epoch_03=if_else(time_from_ext_to_propofol_infusion_min>120 & time_from_ext_to_propofol_infusion_min<=180,opioid_rate,NULL)
    ,propofol_infusion_epoch_04=if_else(time_from_ext_to_propofol_infusion_min>180 & time_from_ext_to_propofol_infusion_min<=240,opioid_rate,NULL)
    ,propofol_infusion_epoch_05=if_else(time_from_ext_to_propofol_infusion_min>240 & time_from_ext_to_propofol_infusion_min<=300,opioid_rate,NULL)
    ,propofol_infusion_epoch_06=if_else(time_from_ext_to_propofol_infusion_min>300 & time_from_ext_to_propofol_infusion_min<=360,opioid_rate,NULL)
    ,propofol_infusion_epoch_07=if_else(time_from_ext_to_propofol_infusion_min>360 & time_from_ext_to_propofol_infusion_min<=420,opioid_rate,NULL)
    ,propofol_infusion_epoch_08=if_else(time_from_ext_to_propofol_infusion_min>420 & time_from_ext_to_propofol_infusion_min<=480,opioid_rate,NULL)
    ,propofol_infusion_epoch_09=if_else(time_from_ext_to_propofol_infusion_min>480 & time_from_ext_to_propofol_infusion_min<=540,opioid_rate,NULL)
    ,propofol_infusion_epoch_10=if_else(time_from_ext_to_propofol_infusion_min>540 & time_from_ext_to_propofol_infusion_min<=600,opioid_rate,NULL)
    ,propofol_infusion_epoch_11=if_else(time_from_ext_to_propofol_infusion_min>600 & time_from_ext_to_propofol_infusion_min<=660,opioid_rate,NULL)
    ,propofol_infusion_epoch_12=if_else(time_from_ext_to_propofol_infusion_min>660 & time_from_ext_to_propofol_infusion_min<=720,opioid_rate,NULL)
  )


cohort_with_propofol_infusion_epoch<-cohort_with_propofol_infusion_epoch%>%
  select(subject_id,propofol_infusion_epoch_01,propofol_infusion_epoch_02,propofol_infusion_epoch_03,propofol_infusion_epoch_04,propofol_infusion_epoch_05,propofol_infusion_epoch_06,propofol_infusion_epoch_07,propofol_infusion_epoch_08,propofol_infusion_epoch_09,propofol_infusion_epoch_10,propofol_infusion_epoch_11,propofol_infusion_epoch_12)%>%
  group_by(subject_id)%>%
  #summarize(mean(value,na.rm=TRUE))
  summarise_all(my.max)
```

### Bolus Drugs


#### propofol

##### Data extraction

```{r eval=FALSE, include=FALSE}
query<-"
SELECT
  inputevents_mv.subject_id,
  inputevents_mv.hadm_id,
  inputevents_mv.icustay_id,
  inputevents_mv.itemid,
  COALESCE(inputevents_mv.storetime,inputevents_mv.starttime) AS charttime_drugs_bolus,
  inputevents_mv.amount,
  inputevents_mv.amountuom,
  inputevents_mv.ordercategorydescription
From
  `physionet-data.mimiciii_clinical.inputevents_mv` inputevents_mv
    
WHERE
  inputevents_mv.itemid In (222168)
  AND ordercategorydescription = 'Drug Push' "

propofol_bolus_cohort_24<-query_exec(query, project = project_HST,use_legacy_sql = F,max_pages = Inf)

propofol_bolus_cohort_24$itemid[propofol_bolus_cohort_24$itemid==222168]<-'propofol'
```

##### Units equivalence

!! TODO: Change units equivalence

propofol =  1 milligram of morphine(ref) IV (225154) is equivalent to .01mg Fentanyl IV (221744).
1 mcg of morphine = 0.001 mg of morphine
1 mcg of fentanyl = 0.1 mg of morphine
1 mg of fentanyl = 100 mg of morphine

```{r}
#nested if else function

!! TODO: Change units equivalence

i <- function(if_stat, then) {
  if_stat <- lazyeval::expr_text(if_stat)
  then    <- lazyeval::expr_text(then)
  sprintf("ifelse(%s, %s, ", if_stat, then)
}

e <- function(else_ret) {
  else_ret <- lazyeval::expr_text(else_ret)
  else_ret
}

ie <- function(...) {
  args <- list(...)
  
  for (i in 1:(length(args) - 1) ) {
      if (substr(args[[i]], 1, 6) != "ifelse") {
        stop("All but the last argument, need to be i functions.", call. = FALSE)
      }
  }
  if (substr(args[[length(args)]], 1, 6) == "ifelse"){
    stop("Last argument needs to be an e function.", call. = FALSE)
  }
  args$final <- paste(rep(')', length(args) - 1), collapse = '')
  eval_string <- do.call('paste', args)
  eval(parse(text = eval_string))
}

propofol_bolus_cohort_24['opioid_amount']<-NA
# * 225154 Morphine Sulfate
# * 221744 Fentanyl
propofol_bolus_cohort_24$opioid_amount <- 
  ie(
    # 1 mcg of morphine = 0.001 mg of morphine
    i(propofol_bolus_cohort_24$itemid=='Morphine' & propofol_bolus_cohort_24$amountuom=='mcg',round(propofol_bolus_cohort_24$amount*0.001,2)),
    #1 mcg of fentanyl = 0.1 mg of morphine
    i(propofol_bolus_cohort_24$itemid=='Fentanyl' & propofol_bolus_cohort_24$amountuom=='mcg',round(propofol_bolus_cohort_24$amount*0.1,2)),
    #1 mg of fentanyl = 100 mg of morphine
    i(propofol_bolus_cohort_24$itemid=='Fentanyl' & propofol_bolus_cohort_24$amountuom=='mg',round(propofol_bolus_cohort_24$amount*100,2)),
    
    e(round(propofol_bolus_cohort_24$amount,2))
  )
```


##### Epochs Creation (total amount mg)

```{r eval=FALSE, include=FALSE}
library(dplyr)
propofol_bolus_from_patients_tofilter<-inner_join(cmo_and_extubation_and_death_24[,c('subject_id','icustay_id','charttime.extubation','deathtime')], propofol_bolus_cohort_24)

# we noticed some timezones adrugs_bolus alteterd, so we drugs_bolusset them
propofol_bolus_from_patients_tofilter$charttime_drugs_bolus<-as.character(propofol_bolus_from_patients_tofilter$charttime_drugs_bolus)
propofol_bolus_from_patients_tofilter$charttime.extubation<-as.character(propofol_bolus_from_patients_tofilter$charttime.extubation)
propofol_bolus_from_patients_tofilter$deathtime<-as.character(propofol_bolus_from_patients_tofilter$deathtime)


propofol_bolus_from_patients_tofilter$charttime_drugs_bolus<-as.POSIXct(propofol_bolus_from_patients_tofilter$charttime_drugs_bolus, format='%Y-%m-%d %H:%M:%S', tz="GMT")
propofol_bolus_from_patients_tofilter$charttime.extubation<-as.POSIXct(propofol_bolus_from_patients_tofilter$charttime.extubation, format='%Y-%m-%d %H:%M:%S', tz="GMT")
propofol_bolus_from_patients_tofilter$deathtime<-as.POSIXct(propofol_bolus_from_patients_tofilter$deathtime, format='%Y-%m-%d %H:%M:%S', tz="GMT")

propofol_bolus_from_patients_tofilter['time_from_ext_to_propofol_bolus_min']<-difftime(propofol_bolus_from_patients_tofilter$charttime_drugs_bolus,propofol_bolus_from_patients_tofilter$charttime.extubation,units = 'mins')
  

#Drug Push is Bolus, so I filtered them out
propofol_bolus_after_ext<-propofol_bolus_from_patients_tofilter %>%
  filter( 
          time_from_ext_to_propofol_bolus_min >=0 
          )

# propofol =  1 milligram of morphine IV (225154) is equivalent to .01 mg Fentanyl IV (221744).

n_distinct(propofol_bolus_after_ext$subject_id) 
# 355 patients with time_from_ext_to_propofol_bolus_min >=-2*60 1/7/18
# 322 patients with time_from_ext_to_propofol_bolus_min >=0 2/12/19


library(dplyr)
## if(any(gdrugs_boluspl("package:plyr", search()))) detach("package:plyr") else message("plyr not loaded")
cohort_with_propofol_bolus_epoch<-propofol_bolus_after_ext %>%
  mutate(
 propofol_bolus_epoch_01=if_else(time_from_ext_to_propofol_bolus_min>=0 & time_from_ext_to_propofol_bolus_min<=60,opioid_amount,NULL)
,propofol_bolus_epoch_02=if_else(time_from_ext_to_propofol_bolus_min>60 & time_from_ext_to_propofol_bolus_min<=120,opioid_amount,NULL)
,propofol_bolus_epoch_03=if_else(time_from_ext_to_propofol_bolus_min>120 & time_from_ext_to_propofol_bolus_min<=180,opioid_amount,NULL)
,propofol_bolus_epoch_04=if_else(time_from_ext_to_propofol_bolus_min>180 & time_from_ext_to_propofol_bolus_min<=240,opioid_amount,NULL)
,propofol_bolus_epoch_05=if_else(time_from_ext_to_propofol_bolus_min>240 & time_from_ext_to_propofol_bolus_min<=300,opioid_amount,NULL)
,propofol_bolus_epoch_06=if_else(time_from_ext_to_propofol_bolus_min>300 & time_from_ext_to_propofol_bolus_min<=360,opioid_amount,NULL)
,propofol_bolus_epoch_07=if_else(time_from_ext_to_propofol_bolus_min>360 & time_from_ext_to_propofol_bolus_min<=420,opioid_amount,NULL)
,propofol_bolus_epoch_08=if_else(time_from_ext_to_propofol_bolus_min>420 & time_from_ext_to_propofol_bolus_min<=480,opioid_amount,NULL)
,propofol_bolus_epoch_09=if_else(time_from_ext_to_propofol_bolus_min>480 & time_from_ext_to_propofol_bolus_min<=540,opioid_amount,NULL)
,propofol_bolus_epoch_10=if_else(time_from_ext_to_propofol_bolus_min>540 & time_from_ext_to_propofol_bolus_min<=600,opioid_amount,NULL)
,propofol_bolus_epoch_11=if_else(time_from_ext_to_propofol_bolus_min>600 & time_from_ext_to_propofol_bolus_min<=660,opioid_amount,NULL)
,propofol_bolus_epoch_12=if_else(time_from_ext_to_propofol_bolus_min>660 & time_from_ext_to_propofol_bolus_min<=720,opioid_amount,NULL)
    )

my.sum <- function(x) ifelse( !all(is.na(x)), sum(x, na.rm=T), NA)

cohort_with_propofol_bolus_epoch<-cohort_with_propofol_bolus_epoch%>%
  select(subject_id,propofol_bolus_epoch_01,propofol_bolus_epoch_02,propofol_bolus_epoch_03,propofol_bolus_epoch_04,propofol_bolus_epoch_05,propofol_bolus_epoch_06,propofol_bolus_epoch_07,propofol_bolus_epoch_08,propofol_bolus_epoch_09,propofol_bolus_epoch_10,propofol_bolus_epoch_11,propofol_bolus_epoch_12)%>%
  group_by(subject_id)%>%
  #summarize(mean(value,na.rm=TRUE))
  summarise_all(my.sum)
```